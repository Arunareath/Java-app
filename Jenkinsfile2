pipeline {
    agent {
        kubernetes{
            yaml '''
apiVersion: v1
kind: Pod
metadata:
  app: jenkins
spec:
  containers:
  - name: maven
    image: maven:alpine
    command: ["sh", "-c", "echo 'Maven container started'; sleep 36000"]
  - name: docker 
    image: docker
    command: ["sh", "-c", "echo 'Docker container started'; sleep 36000"]
  volumeMounts:
  - mountPath: /var/lib/docker.sock
    name: docker-path
  volumes:
  - name: docker-path
    hostPath:
      path: /var/lib/docker.sock
'''
        } 
    }
    stages {
        stage('Clone') {
            steps {
                container('maven') {
                    checkout scm
                    sh 'mvn package'
                }
            }
        }
        stage('Build-Docker-image') {
            steps {
                container('docker') {
                    sh 'cp target/my-app* docker-context'
                    script {
                        docker.build('my-docker-image:latest', 'docker-context')
                    }
                }
            }
        }
        stage('Login to Docker hub') {
            steps {
                container('docker') {
                    sh 'docker login -u Arunareath -p ^runfive5App'
                }
            }
        }
        stage('push docker image to docker hub') {
            steps {
                container('docker') {
                    sh 'docker push my-docker-image:latest'
                }
            }
        }
        stage('docker logout'){
           steps{
              container('docker') {
                    sh 'docker logout'
                }
             }
        }
    }
}
